#!/bin/bash -ex

main () {
  local environment="$1"
  local namespace="data-processing"
  local jumpgate_user_name="deploy-data-processing"
  local service_name="prism-long-term-storage"
  local release_name="$service_name-$environment"
  local package_loc="prism-lts-0.1.0.tgz"
  local helm_install_cmd="helm install --timeout 600 --replace --tiller-namespace $namespace --namespace $namespace --name $release_name ./$package_loc --set tags.prism-lts-$environment-values=true"
  local helm_upgrade_cmd="helm upgrade --install --timeout 600 --tiller-namespace $namespace --namespace $namespace $release_name ./$package_loc --set tags.prism-lts-$environment-values=true"

  helm package prism-lts
  scp "$package_loc" "$jumpgate_user_name@$environment-jumpgate-01.commonstack.io:"
  set +e
  ssh "$jumpgate_user_name@$environment-jumpgate-01.commonstack.io" "helm ls --tiller-namespace $namespace --namespace $namespace $release_name | grep DEPLOYED"
  local ls_exit_code="$?"
  set -e
  if [[ "$ls_exit_code" = "1" ]]; then
    ssh "$jumpgate_user_name@$environment-jumpgate-01.commonstack.io" "$helm_install_cmd"
  else
    ssh "$jumpgate_user_name@$environment-jumpgate-01.commonstack.io" "$helm_upgrade_cmd"
  fi
}

main "$@"
